#!/bin/bash
# Setting variables
# set -x
GREEN="\033[0;32m"
YELLOW="\033[0;33m"
RED="\033[0;31m"
BLUE="\033[0;36m"
NORM="\033[0m"
CML_IP=10.122.49.111
cml_username=admin
cml_password='C!sco123'

function help
{
  echo "Usage: delete_devices-sites.sh [-d x.x.x.x] [-h] [-x]"
  echo ""
  echo "   -d  DNA-Center IP address"
  echo "   -h  Help menue"
  echo "   -x  Delete devices"
  echo ""
  echo ""
}

function get_auth_token
{
    CML_TOKEN=`curl --header "Content-Type:application/json" --header "Accept:application/json" -X POST --data '{"username":"'$cml_username'","password":"'$cml_password'"}' --insecure -s https://${CML_IP}/api/v0/authenticate | awk -F '"' '{print $2}' 2>&1`
    printf "${YELLOW}Your CML token is: ${GREEN}${CML_TOKEN}${NORM}\n"
    printf "\n"
}

function create_lab_import
{
    LAB_ID=`curl --header "Content-Type:application/json" --header "Accept:application/json" --header "authorization: Bearer ${CML_TOKEN}" -X POST --data-raw $'lab:\n  description: \'\'\n  notes: \'\'\n  title: BRKOPS-2317_DIGITAL-TWIN\n  version: 0.1.0\nlinks:\n  - id: l0\n    n1: n2\n    n2: n3\n    i1: i0\n    i2: i0\n    label: ext-conn-0-port<->unmanaged-switch-0-port0\n  - id: l1\n    n1: n0\n    n2: n3\n    i1: i1\n    i2: i1\n    label: SWITCH01-GigabitEthernet0/0<->unmanaged-switch-0-port1\n  - id: l2\n    n1: n1\n    n2: n3\n    i1: i1\n    i2: i2\n    label: SWITCH02-GigabitEthernet0/0<->unmanaged-switch-0-port2\n  - id: l3\n    n1: n0\n    n2: n1\n    i1: i2\n    i2: i2\n    label: SWITCH01-GigabitEthernet0/1<->SWITCH02-GigabitEthernet0/1\nnodes:\n  - boot_disk_size: 0\n    configuration: |-\n      Building configuration...\n\n      Current configuration : 3174 bytes\n      \u0021\n      \u0021 Last configuration change at 23:18:39 UTC Mon Dec 12 2022\n      \u0021\n      version 15.9\n      service timestamps debug datetime msec\n      service timestamps log datetime msec\n      no service password-encryption\n      \u0021\n      hostname SWITCH01\n      \u0021\n      boot-start-marker\n      boot-end-marker\n      \u0021\n      \u0021\n      no logging console\n      \u0021\n      no aaa new-model\n      \u0021\n      \u0021\n      \u0021\n      mmi polling-interval 60\n      no mmi auto-configure\n      no mmi pvc\n      mmi snmp-timeout 180\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      ip domain name brkops-2317.twin\n      crypto key generate rsa modulus 4096\n      ip cef\n      no ipv6 cef\n      \u0021\n      multilink bundle-name authenticated\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      username ansible privilege 15 secret 9 $9$JfdItno7BJBcQf$LBiEMYcE6RBR6E7RGmGDXo9EnxtfT7mQZ3Kk7j8D1to\n      \u0021\n      redundancy\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      interface GigabitEthernet0/0\n       ip address 10.10.10.220 255.255.255.0\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      interface GigabitEthernet0/1\n       no ip address\n       shutdown\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      interface GigabitEthernet0/2\n       no ip address\n       shutdown\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      interface GigabitEthernet0/3\n       no ip address\n       shutdown\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      ip forward-protocol nd\n      \u0021\n      \u0021\n      no ip http server\n      no ip http secure-server\n      \u0021\n      ipv6 ioam timestamp\n      \u0021\n      \u0021\n      \u0021\n      control-plane\n      \u0021\n      banner exec ^C\n      **************************************************************************\n      * IOSv is strictly limited to use for evaluation, demonstration and IOS  *\n      * education. IOSv is provided as-is and is not supported by Cisco\'s      *\n      * Technical Advisory Center. Any use or disclosure, in whole or in part, *\n      * of the IOSv Software or Documentation to any third party for any       *\n      * purposes is expressly prohibited except as otherwise authorized by     *\n      * Cisco in writing.                                                      *\n      **************************************************************************^C\n      banner incoming ^C\n      **************************************************************************\n      * IOSv is strictly limited to use for evaluation, demonstration and IOS  *\n      * education. IOSv is provided as-is and is not supported by Cisco\'s      *\n      * Technical Advisory Center. Any use or disclosure, in whole or in part, *\n      * of the IOSv Software or Documentation to any third party for any       *\n      * purposes is expressly prohibited except as otherwise authorized by     *\n      * Cisco in writing.                                                      *\n      **************************************************************************^C\n      banner login ^C\n      **************************************************************************\n      * IOSv is strictly limited to use for evaluation, demonstration and IOS  *\n      * education. IOSv is provided as-is and is not supported by Cisco\'s      *\n      * Technical Advisory Center. Any use or disclosure, in whole or in part, *\n      * of the IOSv Software or Documentation to any third party for any       *\n      * purposes is expressly prohibited except as otherwise authorized by     *\n      * Cisco in writing.                                                      *\n      **************************************************************************^C\n      \u0021\n      line con 0\n       exec-timeout 0 0\n      line aux 0\n      line vty 0 4\n       login local\n       transport input ssh\n      line vty 5 15\n       login local\n       transport input ssh\n      \u0021\n      no scheduler allocate\n      \u0021\n      end\n    cpu_limit: 100\n    cpus: 1\n    data_volume: 0\n    hide_links: false\n    id: n0\n    label: SWITCH01\n    node_definition: iosv\n    ram: 512\n    tags: []\n    x: 240\n    y: 106\n    interfaces:\n      - id: i0\n        label: Loopback0\n        type: loopback\n      - id: i1\n        label: GigabitEthernet0/0\n        slot: 0\n        type: physical\n      - id: i2\n        label: GigabitEthernet0/1\n        slot: 1\n        type: physical\n      - id: i3\n        label: GigabitEthernet0/2\n        slot: 2\n        type: physical\n      - id: i4\n        label: GigabitEthernet0/3\n        slot: 3\n        type: physical\n  - boot_disk_size: 0\n    configuration: |-\n      Building configuration...\n\n      Current configuration : 3174 bytes\n      \u0021\n      \u0021 Last configuration change at 23:22:55 UTC Mon Dec 12 2022\n      \u0021\n      version 15.9\n      service timestamps debug datetime msec\n      service timestamps log datetime msec\n      no service password-encryption\n      \u0021\n      hostname SWITCH02\n      \u0021\n      boot-start-marker\n      boot-end-marker\n      \u0021\n      \u0021\n      no logging console\n      \u0021\n      no aaa new-model\n      \u0021\n      \u0021\n      \u0021\n      mmi polling-interval 60\n      no mmi auto-configure\n      no mmi pvc\n      mmi snmp-timeout 180\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      ip domain name brkops-2317.twin\n      crypto key generate rsa modulus 4096\n      ip cef\n      no ipv6 cef\n      \u0021\n      multilink bundle-name authenticated\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      username ansible privilege 15 secret 9 $9$hbzwdV.1z6mgFv$oEWV/jTIubuIZR8UwhQvK7LgTrnpO1fnNNxf.HjTCrU\n      \u0021\n      redundancy\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      \u0021\n      interface GigabitEthernet0/0\n       ip address 10.10.10.221 255.255.255.0\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      interface GigabitEthernet0/1\n       no ip address\n       shutdown\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      interface GigabitEthernet0/2\n       no ip address\n       shutdown\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      interface GigabitEthernet0/3\n       no ip address\n       shutdown\n       duplex auto\n       speed auto\n       media-type rj45\n      \u0021\n      ip forward-protocol nd\n      \u0021\n      \u0021\n      no ip http server\n      no ip http secure-server\n      \u0021\n      ipv6 ioam timestamp\n      \u0021\n      \u0021\n      \u0021\n      control-plane\n      \u0021\n      banner exec ^C\n      **************************************************************************\n      * IOSv is strictly limited to use for evaluation, demonstration and IOS  *\n      * education. IOSv is provided as-is and is not supported by Cisco\'s      *\n      * Technical Advisory Center. Any use or disclosure, in whole or in part, *\n      * of the IOSv Software or Documentation to any third party for any       *\n      * purposes is expressly prohibited except as otherwise authorized by     *\n      * Cisco in writing.                                                      *\n      **************************************************************************^C\n      banner incoming ^C\n      **************************************************************************\n      * IOSv is strictly limited to use for evaluation, demonstration and IOS  *\n      * education. IOSv is provided as-is and is not supported by Cisco\'s      *\n      * Technical Advisory Center. Any use or disclosure, in whole or in part, *\n      * of the IOSv Software or Documentation to any third party for any       *\n      * purposes is expressly prohibited except as otherwise authorized by     *\n      * Cisco in writing.                                                      *\n      **************************************************************************^C\n      banner login ^C\n      **************************************************************************\n      * IOSv is strictly limited to use for evaluation, demonstration and IOS  *\n      * education. IOSv is provided as-is and is not supported by Cisco\'s      *\n      * Technical Advisory Center. Any use or disclosure, in whole or in part, *\n      * of the IOSv Software or Documentation to any third party for any       *\n      * purposes is expressly prohibited except as otherwise authorized by     *\n      * Cisco in writing.                                                      *\n      **************************************************************************^C\n      \u0021\n      line con 0\n       exec-timeout 0 0\n      line aux 0\n      line vty 0 4\n       login local\n       transport input ssh\n      line vty 5 15\n       login local\n       transport input ssh\n      \u0021\n      no scheduler allocate\n      \u0021\n      end\n    cpu_limit: 100\n    cpus: 1\n    data_volume: 0\n    hide_links: false\n    id: n1\n    label: SWITCH02\n    node_definition: iosv\n    ram: 512\n    tags: []\n    x: 428\n    y: 104\n    interfaces:\n      - id: i0\n        label: Loopback0\n        type: loopback\n      - id: i1\n        label: GigabitEthernet0/0\n        slot: 0\n        type: physical\n      - id: i2\n        label: GigabitEthernet0/1\n        slot: 1\n        type: physical\n      - id: i3\n        label: GigabitEthernet0/2\n        slot: 2\n        type: physical\n      - id: i4\n        label: GigabitEthernet0/3\n        slot: 3\n        type: physical\n  - boot_disk_size: 0\n    configuration: bridge1\n    cpu_limit: 100\n    cpus: 0\n    data_volume: 0\n    hide_links: false\n    id: n2\n    label: ext-conn-0\n    node_definition: external_connector\n    ram: 0\n    tags: []\n    x: 331\n    y: -108\n    interfaces:\n      - id: i0\n        label: port\n        slot: 0\n        type: physical\n  - boot_disk_size: 0\n    configuration: ums-123ace00-f5\n    cpu_limit: 100\n    cpus: 0\n    data_volume: 0\n    hide_links: false\n    id: n3\n    label: unmanaged-switch-0\n    node_definition: unmanaged_switch\n    ram: 0\n    tags: []\n    x: 331\n    y: -18\n    interfaces:\n      - id: i0\n        label: port0\n        slot: 0\n        type: physical\n      - id: i1\n        label: port1\n        slot: 1\n        type: physical\n      - id: i2\n        label: port2\n        slot: 2\n        type: physical\n      - id: i3\n        label: port3\n        slot: 3\n        type: physical\n      - id: i4\n        label: port4\n        slot: 4\n        type: physical\n      - id: i5\n        label: port5\n        slot: 5\n        type: physical\n      - id: i6\n        label: port6\n        slot: 6\n        type: physical\n      - id: i7\n        label: port7\n        slot: 7\n        type: physical\n' --insecure -s https://${CML_IP}/api/v0/import | jq '.' | grep "id" | awk -F '"' '{print $4}'`
    printf "${YELLOW}Your Lab ID is: ${GREEN}${LAB_ID}${NORM}\n"
    curl --header "Content-Type:application/json" --header "Accept:application/json" --header "authorization: Bearer ${CML_TOKEN}" -X PUT --insecure -s https://${CML_IP}/api/v0/labs/${LAB_ID}/start | jq '.'
}

function exit_abnormal
{          
  printf "${RED}!!!!! OH nooooo ... something went wrong! Try again! !!!!!${NORM}\n"
  help
  exit 1
} 

if [ "$#" == "0" ]
  then
    help
	else
    while getopts "dfh" opt
    do
      case $opt in
        d) get_auth_token
            ;;
        h) help
            ;;
        f) create_lab_import
            ;;
      esac
    done
    shift $(($OPTIND -1))
fi